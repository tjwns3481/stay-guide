// Prisma Schema for Roomy
// Database: Supabase (PostgreSQL with pgvector)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pgvector(map: "vector")]
}

// 사용자 (Clerk 연동)
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique @map("clerk_id")
  email     String   @unique
  name      String?
  imageUrl  String?  @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  guides   Guide[]
  licenses License[]

  @@map("users")
}

// 안내서
model Guide {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  slug              String   @unique
  title             String
  accommodationName String   @map("accommodation_name")
  isPublished       Boolean  @default(false) @map("is_published")
  themeId           String?  @map("theme_id")
  themeSettings     Json?    @map("theme_settings") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  blocks      Block[]
  embeddings  GuideEmbedding[]
  aiConversations AiConversation[]

  @@index([userId])
  @@index([slug])
  @@map("guides")
}

// 블록 (안내서 콘텐츠)
model Block {
  id        String   @id @default(cuid())
  guideId   String   @map("guide_id")
  type      String   // hero, quick_info, amenities, map, host_pick, notice
  order     Int
  content   Json     @db.JsonB
  isVisible Boolean  @default(true) @map("is_visible")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  guide Guide @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@index([guideId])
  @@index([guideId, order])
  @@map("blocks")
}

// 라이선스 (스마트스토어 연동)
model License {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  licenseKey     String    @unique @map("license_key")
  plan           String    // free, monthly, biannual, annual
  status         String    @default("active") // active, expired, cancelled
  features       Json      @db.JsonB // 활성화된 기능 목록
  startsAt       DateTime  @map("starts_at")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([licenseKey])
  @@map("licenses")
}

// AI 컨시어지용 임베딩 (pgvector)
model GuideEmbedding {
  id        String                   @id @default(cuid())
  guideId   String                   @map("guide_id")
  blockId   String?                  @map("block_id")
  content   String
  embedding Unsupported("vector(1536)")
  metadata  Json?                    @db.JsonB
  createdAt DateTime                 @default(now()) @map("created_at")

  // Relations
  guide Guide @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@index([guideId])
  @@map("guide_embeddings")
}

// AI 대화 기록
model AiConversation {
  id        String   @id @default(cuid())
  guideId   String   @map("guide_id")
  sessionId String   @map("session_id")
  role      String   // user, assistant
  content   String
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  guide Guide @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@index([guideId])
  @@index([sessionId])
  @@map("ai_conversations")
}
